document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        renderContent(e.target.result);
    };
    reader.readAsText(file);
});

function renderContent(text) {
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = '';

    let categoryMap = {}; // 중복 방지용 객체
    let currentCategory = null;
    let currentMonth = null;
    let categoryDiv, monthsDiv, monthDiv, versesDiv;

    lines.forEach(line => {
        if (line.match(/^(유아부|저학년|고학년) \(\S+\) - 월 \d+개, 연간 \d+개$/)) {
            currentCategory = line.split(' ')[0]; // 카테고리 추출

            if (!categoryMap[currentCategory]) {
                categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                const categoryTitle = document.createElement('div');
                categoryTitle.className = `category-title ${currentCategory === '유아부' ? 'infant' : currentCategory === '저학년' ? 'junior' : 'senior'}`;
                categoryTitle.textContent = currentCategory;
                categoryTitle.onclick = function() { toggleMonths(this); };
                categoryDiv.appendChild(categoryTitle);

                monthsDiv = document.createElement('div');
                monthsDiv.className = 'months';
                categoryDiv.appendChild(monthsDiv);

                contentDiv.appendChild(categoryDiv);
                categoryMap[currentCategory] = monthsDiv; // 중복 방지용 저장
            } else {
                monthsDiv = categoryMap[currentCategory];
            }
        }
        else if (line.match(/^\d+월: .+$/) && currentCategory) {
            currentMonth = line;
            monthDiv = document.createElement('div');
            monthDiv.className = 'month-card';

            const monthTitle = document.createElement('div');
            monthTitle.className = 'month-title';
            monthTitle.textContent = currentMonth;
            monthTitle.onclick = function() { toggleVerses(this); };
            monthDiv.appendChild(monthTitle);

            versesDiv = document.createElement('div');
            versesDiv.className = 'verses';
            monthDiv.appendChild(versesDiv);

            monthsDiv.appendChild(monthDiv);
        }
        else if (line.match(/^".*"/) && currentMonth) {
            const [textPart, desc] = line.split(' - ');
            const match = textPart.match(/"(.*)" \((.*)\)/);
            if (match) {
                const [text, ref] = match.slice(1);
                const verseDiv = document.createElement('div');
                verseDiv.className = 'verse';
                verseDiv.setAttribute('data-text', `"${text}" (${ref})`);
                verseDiv.setAttribute('data-desc', desc);
                verseDiv.onclick = function() { toggleSelect(this); };

                const verseText = document.createElement('span');
                verseText.className = 'verse-text';
                verseText.textContent = text;
                verseDiv.appendChild(verseText);

                const verseRef = document.createElement('span');
                verseRef.className = 'verse-ref';
                verseRef.innerHTML = `(${ref}) <span class="verse-desc">${desc}</span>`;
                verseDiv.appendChild(verseRef);

                versesDiv.appendChild(verseDiv);
            }
        }
    });
}

function toggleMonths(element) {
    const monthsDiv = element.nextElementSibling;
    monthsDiv.style.display = monthsDiv.style.display === 'none' ? 'block' : 'none';
}

function toggleVerses(element) {
    const versesDiv = element.nextElementSibling;
    versesDiv.style.display = versesDiv.style.display === 'none' ? 'block' : 'none';
}

function toggleSelect(element) {
    element.classList.toggle('selected');
}
